<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Source Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Font Awesome for Icons (Trash, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* BASE STYLES */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light background */
        }
        .container-card {
            max-width: 1300px;
            margin: auto;
            border-radius: 8px; /* Slightly less rounded than before */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Subtle shadow */
            overflow: hidden;
            background-color: white;
        }
        
        /* NEW BACK LINK STYLE */
        .back-link {
            /* Blue link styling matching the reference */
            @apply text-blue-600 font-semibold text-sm cursor-pointer hover:text-blue-800 transition duration-150 flex items-center;
        }
        .back-link span {
            /* Styling for the chevron */
            @apply font-bold text-xl leading-none;
        }

        /* HEADER AND CONTROL STYLES (Matching Reference Image) */
        .controls {
            /* Changed to justify-start to align everything left, and maintained flex-wrap for mobile responsiveness */
            @apply flex flex-wrap justify-start items-center p-4 border-b border-gray-300;
        }
        .filter-group {
            /* This is now the main container for all filters and buttons */
            @apply flex flex-wrap gap-2;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            @apply shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition duration-150;
        }

        /* BUTTON STYLES (Matching Reference Image) */
        .filter-group button { /* Targeting buttons inside the combined group */
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .search-btn {
            background-color: #007bff; /* Primary Blue */
            color: white;
        }
        .search-btn:hover { background-color: #0056b3; }

        .clear-btn {
            background-color: transparent;
            border-color: #007bff;
            color: #007bff;
        }
        .clear-btn:hover { background-color: #e6f0ff; }

        .primary-btn {
            background-color: #28a745; /* Green for 'Add Check' */
            color: white;
        }
        .primary-btn:hover { background-color: #1e7e34; }
        
        #manageCategoriesBtn {
            background-color: #6c757d; /* Secondary color for management button */
            color: white;
        }
        #manageCategoriesBtn:hover { background-color: #5a6268; }

        /* TABLE STYLES (Matching Reference Image) */
        #dataTable {
            @apply min-w-full divide-y divide-gray-200;
            font-size: 14px;
        }
        #dataTable th {
            @apply bg-gray-50 text-gray-600 font-semibold uppercase tracking-wider text-xs;
            padding: 10px 15px;
            border-right: 1px solid #f3f3f3;
        }
        #dataTable td {
            @apply text-gray-800;
            padding: 10px 15px;
            border-right: 1px solid #f3f3f3;
        }
        #dataTable tbody tr:hover {
            background-color: #f8f8f8;
        }
        
        /* Action Button Styling - Changed to Text Color, removed pill background */
        .action-text-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none; /* Removed underline */
            transition: color 0.15s ease;
            white-space: nowrap;
        }
        .update-btn { color: #cc8400; } /* Darker Yellow/Orange */
        .delete-btn { 
            /* Enhanced visibility for the trash icon */
            color: #dc3545; /* Red */
            font-size: 18px; 
            padding: 0 5px;
        } 
        .track-btn { color: #007bff; } /* Blue */

        .update-btn:hover { color: #e0a800; text-decoration: underline; }
        .delete-btn:hover { color: #c82333; }
        .track-btn:hover { color: #0056b3; text-decoration: underline; }

        /* Modal specific styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* POPUP BACKGROUND FIX: Changed from rgba(0,0,0,0.6) to rgba(0,0,0,0.8) */
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            @apply bg-white p-6 md:p-8 rounded-lg shadow-2xl w-11/12 max-w-lg relative;
        }
        /* History Modal is now removed from the UI, but keeping styles just in case for debugging */
        #historyModal .modal-content {
            max-width: 700px; 
        }
        .form-input {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .filter-group {
                width: 100%;
                /* Filters and buttons wrap on mobile */
                flex-wrap: wrap; 
            }
            .filter-group > * {
                flex-grow: 1; /* Filters take equal width */
            }
            /* Make action buttons fit equally on mobile */
            .filter-group > button {
                flex-grow: 1;
            }
        }
        /* Specific highlight styles for character diff */
        .break-words {
            word-break: break-all;
        }
        
        /* Manage Categories Specific Styles */
        .manage-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7f7f7;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .manage-actions {
            display: flex;
            gap: 8px;
        }
        .manage-btn-update {
            color: #007bff;
            font-weight: 500;
        }
        .manage-btn-delete {
            color: #dc3545;
            font-weight: 500;
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="container-card">
    
    <!-- BACK BUTTON SECTION -->
    <div class="p-4 pb-2">
        <a href="#" onclick="history.back(); return false;" class="back-link">
            <span class="text-xl leading-none mr-1">&lt;</span> Back
        </a>
    </div>
    
    <!-- Header and Controls (Now a single combined row for filters and actions) -->
    <div class="controls" id="filterControls">
        
        <!-- Filter Group (COMBINED: Filters and Buttons are in one row) -->
        <div class="filter-group">
            <span class="text-sm text-gray-600 self-center font-semibold whitespace-nowrap">Filter:</span>
            
            <!-- Natcrim Filter (Dropdown) -->
            <select id="filterExampleOf" class="filter-input w-32">
                <option value="">Natcrim</option>
                <!-- Options populated by JS -->
            </select>
            
            <!-- Vendor Filter (Dropdown) -->
            <select id="filterVendor" class="filter-input w-32">
                <option value="">Vendor</option>
                <!-- Options populated by JS -->
            </select>
            
            <!-- Source Name Filter (Text Search) -->
            <input 
                type="text" 
                id="filterSourceName" 
                placeholder="Source Name" 
                class="filter-input w-48"
            >

            <!-- Action Buttons (Now part of the filter group for single-row alignment) -->
            <button id="searchFilterBtn" class="search-btn">Search</button>
            <button id="clearFilterBtn" class="clear-btn">Clear Filters</button>
            
            <!-- New Manage Categories Button -->
            <button id="manageCategoriesBtn"><i class="fas fa-cog"></i> Manage Categories</button>
            
            <button id="addCheckBtn" class="primary-btn">Add New Check</button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container p-4 md:p-6 overflow-x-auto">
        <table id="dataTable" class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="text-left px-3 py-2">Natcrim</th>
                    <th class="text-left px-3 py-2">Source Name</th>
                    <th class="text-left px-3 py-2">Vendor</th>
                    <th class="text-left px-3 py-2">Update</th>
                    <th class="text-left px-3 py-2">Delete</th>
                    <!-- HISTORY COLUMN REMOVED -->
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <!-- Data rows populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Update Modal -->
<div id="addUpdateModal" class="modal">
    <div class="modal-content">
        <button class="close-button absolute top-3 right-5 text-gray-400 hover:text-gray-700 text-3xl font-light leading-none" onclick="closeModal('addUpdateModal')">&times;</button>
        <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
        
        <form id="dataForm">
            <div class="space-y-4">
                <!-- Natcrim Dropdown -->
                <div>
                    <label for="exampleOfSelect" class="block text-sm font-medium text-gray-700 mb-1">Natcrim:</label> 
                    <select id="exampleOfSelect" class="form-input" required title="Indicates the type of registry check (SOR, OIG, or TW)">
                        <option value="">Select Natcrim</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <!-- Source Name Input -->
                <div>
                    <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">Source Name:</label>
                    <input type="text" id="sourceName" class="form-input" required title="The official name of the exclusion list or registry." placeholder="e.g., California Megan's Law (CA DOJ)">
                </div>
                
                <!-- Vendor Dropdown -->
                <div>
                    <label for="vendorSelect" class="block text-sm font-medium text-gray-700 mb-1">Vendor:</label>
                    <select id="vendorSelect" class="form-input" required title="Select the third-party vendor responsible for this check.">
                        <option value="">Select Vendor</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>
            <button type="submit" id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-150 shadow-lg"></button>
        </form>
    </div>
</div>

<!-- Manage Categories Modal -->
<div id="manageCategoriesModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="close-button absolute top-3 right-5 text-gray-400 hover:text-gray-700 text-3xl font-light leading-none" onclick="closeModal('manageCategoriesModal')">&times;</button>
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Manage Categories & Vendors</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Manage Natcrim -->
            <div class="p-4 border rounded-lg">
                <h3 class="text-xl font-semibold mb-3 border-b pb-2">Natcrim Types</h3>
                <div id="natcrimList" class="space-y-2 max-h-48 overflow-y-auto mb-4">
                    <!-- Natcrim items populated by JS -->
                </div>
                <input type="text" id="newNatcrimInput" class="form-input mb-2" placeholder="New Natcrim name">
                <button id="addNatcrimBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">Add New Natcrim</button>
            </div>
            
            <!-- Manage Vendors -->
            <div class="p-4 border rounded-lg">
                <h3 class="text-xl font-semibold mb-3 border-b pb-2">Vendors</h3>
                <div id="vendorList" class="space-y-2 max-h-48 overflow-y-auto mb-4">
                    <!-- Vendor items populated by JS -->
                </div>
                <input type="text" id="newVendorInput" class="form-input mb-2" placeholder="New Vendor name">
                <button id="addVendorBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">Add New Vendor</button>
            </div>
        </div>
        
        <p class="text-sm text-gray-500 mt-4 italic">Use the buttons above to add, rename, or delete categories/vendors.</p>
    </div>
</div>


<!-- History Modal (Hidden from UI) -->
<div id="historyModal" class="modal" style="display:none;">
    <div class="modal-content">
        <button class="close-button absolute top-3 right-5 text-gray-400 hover:text-gray-700 text-3xl font-light leading-none" onclick="closeModal('historyModal')">&times;</button>
        
        <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto mt-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">
                Tracking History for: <span id="historySourceName" class="text-indigo-600 font-bold"></span>
            </h3>
            <ul id="historyList" class="space-y-4">
                <!-- History entries will be populated here -->
            </ul>
        </div>
    </div>
</div>

<script>
    // --- CHARACTER DIFF LOGIC (RETAINED FOR HISTORY LOGGING) ---
    const diffAndHighlightCharLevel = (oldVal, newVal) => {
        let oldOutput = '';
        let newOutput = '';
        
        const maxLen = Math.max(oldVal.length, newVal.length);

        for (let i = 0; i < maxLen; i++) {
            const oldChar = oldVal[i] || '';
            const newChar = newVal[i] || '';

            if (oldChar === newChar) {
                oldOutput += oldChar;
                newOutput += newChar;
            } else {
                if (oldChar) {
                    oldOutput += `<span class="bg-red-200 text-red-800 font-bold">${oldChar}</span>`;
                }
                if (newChar) {
                    newOutput += `<span class="bg-green-200 text-green-800 font-bold">${newChar}</span>`;
                }
            }
        }
        return { old: oldOutput, new: newOutput };
    };

    const highlightChangesInDescription = (description) => {
        const regex = /'([^']*)'/g; 
        const values = [];
        let match;
        while (match = regex.exec(description)) {
            values.push(match[1]);
        }
        
        if (values.length === 2) {
            const oldValue = values[0];
            const newValue = values[1];
            
            const fieldName = description.split(' ')[0];
            
            const highlighted = diffAndHighlightCharLevel(oldValue, newValue);
            
            return `
                ${fieldName} changed: 
                <span class="inline-block px-2 py-0.5 rounded-md bg-red-100 text-red-800 text-xs mr-2">OLD</span>
                <span class="break-words">${highlighted.old}</span>
                <span class="mx-2 text-gray-500 font-semibold">â†’</span>
                <span class="inline-block px-2 py-0.5 rounded-md bg-green-100 text-green-800 text-xs mr-2">NEW</span>
                <span class="break-words">${highlighted.new}</span>
            `;
        } else {
            return description;
        }
    };
    // --- END CHARACTER DIFF LOGIC ---


    document.addEventListener('DOMContentLoaded', () => {
        const dataTableBody = document.querySelector('#dataTable tbody');
        
        // --- CATEGORY STATE ---
        let natcrimCategories = ['GSA/SAM', 'SOR', 'OIG', 'TW'];
        let vendors = ['SJV', 'Rapidcourt'];
        
        // Filter Elements
        const filterExampleOf = document.getElementById('filterExampleOf');
        const filterVendor = document.getElementById('filterVendor');
        const filterSourceName = document.getElementById('filterSourceName');
        
        // Action Buttons
        const searchFilterBtn = document.getElementById('searchFilterBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
        const addCheckBtn = document.getElementById('addCheckBtn');

        // Modals
        const addUpdateModal = document.getElementById('addUpdateModal');
        const manageCategoriesModal = document.getElementById('manageCategoriesModal');
        const modalTitle = document.getElementById('modalTitle');
        const dataForm = document.getElementById('dataForm');
        const saveBtn = document.getElementById('saveBtn');
        
        // Modal Select Fields
        const exampleOfSelect = document.getElementById('exampleOfSelect');
        const vendorSelect = document.getElementById('vendorSelect');
        const sourceNameInput = document.getElementById('sourceName');
        
        // Manage Categories Fields
        const natcrimListDiv = document.getElementById('natcrimList');
        const vendorListDiv = document.getElementById('vendorList');
        const newNatcrimInput = document.getElementById('newNatcrimInput');
        const addNatcrimBtn = document.getElementById('addNatcrimBtn');
        const newVendorInput = document.getElementById('newVendorInput');
        const addVendorBtn = document.getElementById('addVendorBtn');

        const initialTimestamp = (new Date()).toLocaleString();
        
        // --- INITIAL DATA ARRAY ---
        let data = [
            // --- OIG Entries ---
            { exampleOf: 'OIG', sourceName: 'HEALTH & HUMAN SERVICES COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'OIG', sourceName: 'MEDICARE SANCTIONS/EXCLUSION DATABASE COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'OIG', sourceName: 'US_HHS_EXCLUSIONS COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'OIG', sourceName: 'HHS_DATABASE COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'OIG', sourceName: 'US_SAM_EXCLUSIONS COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },

            // --- SOR Entries ---
            { exampleOf: 'SOR', sourceName: 'SEX OFFENDER REGISTRY COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'SOR', sourceName: 'INDIANA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'SOR', sourceName: 'TEXAS SEX OFFENDER REGISTRY COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'SOR', sourceName: 'LOUISIANA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'SOR', sourceName: 'ARIZONA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            
            // --- GSA/SAM Entries ---
            { exampleOf: 'GSA/SAM', sourceName: 'ARREST/US/NATIONAL/RECENTLY_BOOKED COURT', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'New Source Name added.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Federal Agency Debarments (General Services Administration)', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'System for Award Management (SAM) Exclusion List', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Environmental Protection Agency (EPA) Debarments', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Department of Housing and Urban Development (HUD) Exclusions', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Department of Defense (DOD) Suspension & Debarment', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Department of Energy (DOE) Exclusion Records', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Department of Veterans Affairs (VA) Exclusions', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'U.S. Department of Agriculture (USDA) Debarment', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'GSA/SAM', sourceName: 'Department of Transportation (DOT) Debarment Records', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            
            // --- TW (Terrorist Watchlist) Entries ---
            { exampleOf: 'TW', sourceName: 'FBI Terrorist Screening Center (TSC) / TSDB overview', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'FBI Terrorist Watchlisting Transparency document', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'U.S. Dept. of State Foreign Terrorist Organizations (FTO) list', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'OFAC (Treasury) Specially Designated Nationals (SDN) List', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'TSA / No Fly List & Traveler Redress', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'GAO Oversight Reports on Terrorist Watchlists', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { exampleOf: 'TW', sourceName: 'Executive Orders / State Dept sanctions (EO 13224 etc.)', vendor: 'SJV', 
              history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
        ];
        // --- END DATA ARRAY ---

        let isUpdating = false;
        let updatingIndex = -1;

        // --- CORE UI/DATA FUNCTIONS ---

        // Function to refresh dropdown options
        const refreshDropdowns = () => {
            // Natcrim Dropdowns
            [filterExampleOf, exampleOfSelect].forEach(select => {
                let currentValue = select.value;
                select.innerHTML = select === filterExampleOf ? '<option value="">Natcrim</option>' : '<option value="">Select Natcrim</option>';
                natcrimCategories.sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });

            // Vendor Dropdowns
            [filterVendor, vendorSelect].forEach(select => {
                let currentValue = select.value;
                select.innerHTML = select === filterVendor ? '<option value="">Vendor</option>' : '<option value="">Select Vendor</option>';
                vendors.sort().forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        };

        // Function to render the table
        const renderTable = (dataToRender) => {
            dataTableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No results found matching your filter.</td></tr>';
                return;
            }
            dataToRender.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                // Store the permanent index in the button's data attribute
                const permanentIndex = data.findIndex(d => d === item);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.exampleOf}</td>
                    <td class="px-6 py-4">${item.sourceName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.vendor}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="action-text-btn update-btn" data-index="${permanentIndex}">Update</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="action-text-btn delete-btn" data-index="${permanentIndex}" title="Delete Record"><i class="fas fa-trash-can"></i></button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
        };

        // Function to filter the data based on all three criteria
        const applyFilters = () => {
            const selectedExampleOf = filterExampleOf.value;
            const selectedVendor = filterVendor.value;
            const searchTermSourceName = filterSourceName.value.trim().toLowerCase();

            const filteredData = data.filter(item => {
                const matchesExampleOf = !selectedExampleOf || item.exampleOf === selectedExampleOf;
                const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
                const matchesSourceName = !searchTermSourceName || item.sourceName.toLowerCase().includes(searchTermSourceName);

                return matchesExampleOf && matchesVendor && matchesSourceName;
            });

            renderTable(filteredData);
        };
        
        // --- MANAGE CATEGORIES LOGIC ---
        
        const isCategoryUsed = (type, value) => {
            if (type === 'natcrim') {
                return data.some(item => item.exampleOf === value);
            } else if (type === 'vendor') {
                return data.some(item => item.vendor === value);
            }
            return false;
        };

        const renderManagementLists = () => {
            const createListItem = (type, value, list) => {
                const isUsed = isCategoryUsed(type, value);
                const item = document.createElement('div');
                item.className = 'manage-list-item';
                
                item.innerHTML = `
                    <span class="text-sm font-medium">${value}</span>
                    <div class="manage-actions">
                        <button class="text-xs manage-btn-update" data-type="${type}" data-value="${value}">Rename</button>
                        <button class="text-xs manage-btn-delete ${isUsed ? 'opacity-50 cursor-not-allowed' : ''}" 
                                data-type="${type}" 
                                data-value="${value}" 
                                ${isUsed ? 'disabled' : ''}
                                title="${isUsed ? 'Cannot delete: category is currently in use.' : 'Delete category.'}">
                                Delete
                        </button>
                    </div>
                `;
                list.appendChild(item);
            };

            // Render Natcrim List
            natcrimListDiv.innerHTML = '';
            natcrimCategories.sort().forEach(cat => createListItem('natcrim', cat, natcrimListDiv));

            // Render Vendor List
            vendorListDiv.innerHTML = '';
            vendors.sort().forEach(v => createListItem('vendor', v, vendorListDiv));
        };
        
        // Rename Handler for Management Modal
        const handleRename = (type, oldValue) => {
            const newValue = prompt(`Enter new name for ${type} '${oldValue}':`);
            if (newValue && newValue.trim() !== oldValue) {
                const cleanNewValue = newValue.trim();
                
                // Check for duplicates before renaming
                const list = type === 'natcrim' ? natcrimCategories : vendors;
                if (list.includes(cleanNewValue)) {
                    alert(`Error: A ${type} named '${cleanNewValue}' already exists.`);
                    return;
                }

                if (type === 'natcrim') {
                    // Update Natcrim category list
                    const index = natcrimCategories.indexOf(oldValue);
                    if (index !== -1) natcrimCategories[index] = cleanNewValue;
                    
                    // Update main data array
                    data.forEach(item => {
                        if (item.exampleOf === oldValue) item.exampleOf = cleanNewValue;
                    });
                } else if (type === 'vendor') {
                    // Update Vendor list
                    const index = vendors.indexOf(oldValue);
                    if (index !== -1) vendors[index] = cleanNewValue;
                    
                    // Update main data array
                    data.forEach(item => {
                        if (item.vendor === oldValue) item.vendor = cleanNewValue;
                    });
                }

                // Re-render all parts of the UI
                refreshDropdowns();
                applyFilters();
                renderManagementLists();
                alert(`${oldValue} successfully renamed to ${cleanNewValue}.`);
            }
        };
        
        // Delete Handler for Management Modal
        const handleDelete = (type, value) => {
            if (isCategoryUsed(type, value)) {
                alert(`Cannot delete ${type} '${value}': It is currently associated with one or more checks in the main table.`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete the ${type} '${value}'? This cannot be undone.`)) {
                if (type === 'natcrim') {
                    natcrimCategories = natcrimCategories.filter(cat => cat !== value);
                } else if (type === 'vendor') {
                    vendors = vendors.filter(v => v !== value);
                }
                
                refreshDropdowns();
                applyFilters();
                renderManagementLists();
                alert(`${value} deleted successfully.`);
            }
        };

        // Event Listener for Rename and Delete buttons in management modal
        manageCategoriesModal.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('manage-btn-update')) {
                const type = target.getAttribute('data-type');
                const value = target.getAttribute('data-value');
                handleRename(type, value);
            } else if (target.classList.contains('manage-btn-delete') && !target.disabled) {
                const type = target.getAttribute('data-type');
                const value = target.getAttribute('data-value');
                handleDelete(type, value);
            }
        });
        
        // Event Listener for Add Natcrim button
        addNatcrimBtn.addEventListener('click', () => {
            const newCat = newNatcrimInput.value.trim();
            if (!newCat) return;
            if (!natcrimCategories.includes(newCat)) {
                natcrimCategories.push(newCat);
                newNatcrimInput.value = '';
                refreshDropdowns();
                renderManagementLists();
                alert(`New Natcrim type '${newCat}' added!`);
            } else {
                alert(`Natcrim type '${newCat}' already exists.`);
            }
        });

        // Event Listener for Add Vendor button
        addVendorBtn.addEventListener('click', () => {
            const newVendor = newVendorInput.value.trim();
            if (!newVendor) return;
            if (!vendors.includes(newVendor)) {
                vendors.push(newVendor);
                newVendorInput.value = '';
                refreshDropdowns();
                renderManagementLists();
                alert(`New Vendor '${newVendor}' added!`);
            } else {
                 alert(`Vendor '${newVendor}' already exists.`);
            }
        });

        // --- UI INITIALIZATION & EVENT HANDLERS ---
        
        // Initial setup
        refreshDropdowns();
        renderTable(data);
        
        // Open/Close Modals
        manageCategoriesBtn.addEventListener('click', () => {
            renderManagementLists();
            manageCategoriesModal.style.display = 'flex';
        });
        
        addCheckBtn.addEventListener('click', () => {
            openModal('add');
        });

        // --- BUTTON HANDLERS ---
        searchFilterBtn.addEventListener('click', applyFilters);

        clearFilterBtn.addEventListener('click', () => {
            filterExampleOf.value = '';
            filterVendor.value = '';
            filterSourceName.value = '';
            applyFilters();
        });
        // --- END BUTTON HANDLERS ---
        
        // Universal Modal Close Function
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'addUpdateModal') {
                 dataForm.reset();
            }
        };

        const openModal = (mode, index = -1) => {
            isUpdating = mode === 'update';
            updatingIndex = index;
            modalTitle.textContent = isUpdating ? 'Update Existing Check' : 'Add New Check';
            saveBtn.textContent = isUpdating ? 'Save Changes' : 'Add Check';
            
            // Ensure dropdowns are current before setting values
            refreshDropdowns();

            if (isUpdating) {
                const item = data[index];
                exampleOfSelect.value = item.exampleOf;
                sourceNameInput.value = item.sourceName;
                vendorSelect.value = item.vendor;
            } else {
                dataForm.reset();
                // SET VENDOR DEFAULT TO SJV
                vendorSelect.value = 'SJV'; 
            }
            addUpdateModal.style.display = 'flex';
        };

        // Form Submission (Add/Update Logic)
        dataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newExampleOf = exampleOfSelect.value;
            const newSourceName = sourceNameInput.value.trim();
            const newVendor = vendorSelect.value;
            const now = (new Date()).toLocaleString();

            if (isUpdating) {
                const originalItem = data[updatingIndex];
                let updateDetails = [];

                if (originalItem.exampleOf !== newExampleOf) {
                    updateDetails.push(`Natcrim changed from '${originalItem.exampleOf}' to '${newExampleOf}'`);
                }
                if (originalItem.sourceName !== newSourceName) {
                    updateDetails.push(`Source Name changed from '${originalItem.sourceName}' to '${newSourceName}'`);
                }
                if (originalItem.vendor !== newVendor) {
                    updateDetails.push(`Vendor changed from '${originalItem.vendor}' to '${newVendor}'`);
                }

                if (updateDetails.length > 0) {
                    originalItem.history.push({ 
                        timestamp: now, 
                        updateDetails: updateDetails.join(', ') 
                    });
                } else {
                     originalItem.history.push({ 
                        timestamp: now, 
                        updateDetails: 'No changes detected, record touched up.' 
                    });
                }
                
                originalItem.exampleOf = newExampleOf;
                originalItem.sourceName = newSourceName;
                originalItem.vendor = newVendor;

            } else {
                data.push({ 
                    exampleOf: newExampleOf, 
                    sourceName: newSourceName, 
                    vendor: newVendor,
                    history: [{ timestamp: now, updateDetails: 'New record created.' }]
                });
            }
            
            applyFilters(); // Re-render table, respecting current filters
            closeModal('addUpdateModal');
        });

        // Delegate Table Actions (Update, Delete)
        dataTableBody.addEventListener('click', (e) => {
            
            if (e.target.classList.contains('update-btn')) {
                // Get permanent index stored in the data attribute
                const originalIndex = parseInt(e.target.getAttribute('data-index'));
                openModal('update', originalIndex);

            } else if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                // Get permanent index stored in the data attribute
                const targetButton = e.target.closest('.delete-btn');
                const originalIndex = parseInt(targetButton.getAttribute('data-index'));

                // Custom delete confirmation modal
                const confirmMessage = document.createElement('div');
                confirmMessage.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]';
                confirmMessage.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm text-center">
                        <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                        <p class="mb-6">Are you sure you want to delete the record for: <strong>${data[originalIndex].sourceName}</strong>?</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Delete</button>
                            <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmMessage);
                
                document.getElementById('confirmDelete').onclick = function() {
                    data.splice(originalIndex, 1);
                    applyFilters(); // Re-render table after deletion
                    confirmMessage.remove();
                };
                document.getElementById('cancelDelete').onclick = function() {
                    confirmMessage.remove();
                };
            }
        });
    });
</script>

</body>
</html>
