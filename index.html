<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Source Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Font Awesome for Icons (Trash, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* BASE STYLES */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light background */
        }
        .container-card {
            max-width: 1300px;
            margin: auto;
            border-radius: 8px; /* Slightly less rounded than before */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Subtle shadow */
            overflow: hidden;
            background-color: white;
        }
        
        /* NEW BACK LINK STYLE */
        .back-link {
            /* Blue link styling matching the reference */
            @apply text-blue-600 font-semibold text-sm cursor-pointer hover:text-blue-800 transition duration-150 flex items-center;
        }
        .back-link span {
            /* Styling for the chevron */
            @apply font-bold text-xl leading-none;
        }

        /* HEADER AND CONTROL STYLES (Matching Reference Image) */
        .controls {
            /* Changed to justify-start to align everything left, and maintained flex-wrap for mobile responsiveness */
            @apply flex flex-wrap justify-start items-center p-4 border-b border-gray-300;
        }
        .filter-group {
            /* This is now the main container for all filters and buttons */
            @apply flex flex-wrap gap-2;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            @apply shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition duration-150;
        }

        /* BUTTON STYLES (Matching Reference Image) */
        .filter-group button { /* Targeting buttons inside the combined group */
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .search-btn {
            background-color: #007bff; /* Primary Blue */
            color: white;
        }
        .search-btn:hover { background-color: #0056b3; }

        .clear-btn {
            background-color: transparent;
            border-color: #007bff;
            color: #007bff;
        }
        .clear-btn:hover { background-color: #e6f0ff; }

        .primary-btn {
            background-color: #28a745; /* Green for 'Add Check' */
            color: white;
        }
        .primary-btn:hover { background-color: #1e7e34; }
        
        #manageCategoriesBtn {
            background-color: #6c757d; /* Secondary color for management button */
            color: white;
        }
        #manageCategoriesBtn:hover { background-color: #5a6268; }

        /* TABLE STYLES (Matching Reference Image) */
        #dataTable {
            @apply min-w-full divide-y divide-gray-200;
            font-size: 14px;
        }
        #dataTable th {
            @apply bg-gray-50 text-gray-600 font-semibold uppercase tracking-wider text-xs;
            padding: 10px 15px;
            border-right: 1px solid #f3f3f3;
        }
        #dataTable td {
            @apply text-gray-800;
            padding: 10px 15px;
            border-right: 1px solid #f3f3f3;
        }
        #dataTable tbody tr:hover {
            background-color: #f8f8f8;
        }
        
        /* Action Button Styling - Changed to Text Color, removed pill background */
        .action-text-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none; /* Removed underline */
            transition: color 0.15s ease;
            white-space: nowrap;
        }
        .update-btn { color: #cc8400; } /* Darker Yellow/Orange */
        .delete-btn { 
            /* Enhanced visibility for the trash icon */
            color: #dc3545; /* Red */
            font-size: 18px; 
            padding: 0 5px;
        } 
        .track-btn { color: #007bff; } /* Blue */

        .update-btn:hover { color: #e0a800; text-decoration: underline; }
        .delete-btn:hover { color: #c82333; }
        .track-btn:hover { color: #0056b3; text-decoration: underline; }

        /* Modal specific styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* POPUP BACKGROUND FIX: Opaque dark background */
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            @apply bg-white p-6 md:p-8 rounded-lg shadow-2xl w-11/12 max-w-lg relative;
        }
        /* History Modal is now removed from the UI, but keeping styles just in case for debugging */
        #historyModal .modal-content {
            max-width: 700px; 
        }
        .form-input {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .filter-group {
                width: 100%;
                /* Filters and buttons wrap on mobile */
                flex-wrap: wrap; 
            }
            .filter-group > * {
                flex-grow: 1; /* Filters take equal width */
            }
            /* Make action buttons fit equally on mobile */
            .filter-group > button {
                flex-grow: 1;
            }
        }
        /* Specific highlight styles for character diff */
        .break-words {
            word-break: break-all;
        }
        
        /* Manage Categories Specific Styles */
        .manage-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7f7f7;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .manage-actions {
            display: flex;
            gap: 8px;
        }
        .manage-btn-update {
            color: #007bff;
            font-weight: 500;
        }
        .manage-btn-delete {
            color: #dc3545;
            font-weight: 500;
        }
        
        /* Added for New Management Structure */
        .manage-category-select {
            @apply w-full p-2 border border-gray-300 rounded-lg text-sm mb-2;
        }
        .manage-category-pane {
             /* Solid white background for internal panes */
            background-color: white !important; 
        }
        /* Removed .manage-btn-delete:disabled styling */
    </style>
</head>
<body class="p-4 md:p-8">

<div class="container-card">
    
    <!-- BACK BUTTON SECTION -->
    <div class="p-4 pb-2">
        <a href="#" onclick="history.back(); return false;" class="back-link">
            <span class="text-xl leading-none mr-1">&lt;</span> Back
        </a>
    </div>
    
    <!-- Header and Controls (Now a single combined row for filters and actions) -->
    <div class="controls" id="filterControls">
        
        <!-- Filter Group (COMBINED: Filters and Buttons are in one row) -->
        <div class="filter-group">
            <span class="text-sm text-gray-600 self-center font-semibold whitespace-nowrap">Filter:</span>
            
            <!-- Category Filter (Dropdown) -->
            <select id="filterExampleOf" class="filter-input w-32">
                <option value="">Category</option>
                <!-- Options populated by JS -->
            </select>
            
             <!-- Subcategory Filter (Dropdown) -->
            <select id="filterSubCategory" class="filter-input w-32">
                <option value="">Subcategory</option>
                <!-- Options populated by JS (SOR, OIG, etc.) -->
            </select>
            
            <!-- Vendor Filter (Dropdown) -->
            <select id="filterVendor" class="filter-input w-32">
                <option value="">Vendor</option>
                <!-- Options populated by JS -->
            </select>
            
            <!-- Source Name Filter (Text Search) -->
            <input 
                type="text" 
                id="filterSourceName" 
                placeholder="Source Name" 
                class="filter-input w-48"
            >

            <!-- Action Buttons (Now part of the filter group for single-row alignment) -->
            <button id="searchFilterBtn" class="search-btn">Search</button>
            <button id="clearFilterBtn" class="clear-btn">Clear Filters</button>
            
            
            <button id="addCheckBtn" class="primary-btn">Add New Check</button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container p-4 md:p-6 overflow-x-auto">
        <table id="dataTable" class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="text-left px-3 py-2">Category</th>
                    <th class="text-left px-3 py-2">Subcategory</th>
                    <th class="text-left px-3 py-2">Source Name</th>
                    <th class="text-left px-3 py-2">Vendor</th>
                    <th class="text-left px-3 py-2">Update</th>
                    <th class="text-left px-3 py-2">Delete</th>
                    <!-- HISTORY COLUMN REMOVED -->
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <!-- Data rows populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Update Modal -->
<div id="addUpdateModal" class="modal">
    <div class="modal-content">
        <button class="close-button absolute top-3 right-5 text-gray-400 hover:text-gray-700 text-3xl font-light leading-none" onclick="closeModal('addUpdateModal')">&times;</button>
        <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
        
        <form id="dataForm">
            <div class="space-y-4">
                <!-- Category Dropdown -->
                <div>
                    <label for="exampleOfSelect" class="block text-sm font-medium text-gray-700 mb-1">Category:</label> 
                    <select id="exampleOfSelect" class="form-input" required title="Select the main check category (e.g., NATCRIM, SSN).">
                        <option value="">Select Category</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <!-- Subcategory Dropdown -->
                <div>
                    <label for="subCategorySelect" class="block text-sm font-medium text-gray-700 mb-1">Subcategory:</label> 
                    <select id="subCategorySelect" class="form-input" required title="Select the subcategory (e.g., OIG, SOR).">
                        <option value="">Select Subcategory</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <!-- Source Name Input -->
                <div>
                    <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">Source Name:</label>
                    <input type="text" id="sourceName" class="form-input" required title="The official name of the exclusion list or registry." placeholder="e.g., Health & Human Services Court">
                </div>
                
                <!-- Vendor Dropdown -->
                <div>
                    <label for="vendorSelect" class="block text-sm font-medium text-gray-700 mb-1">Vendor:</label>
                    <select id="vendorSelect" class="form-input" required title="Select the third-party vendor responsible for this check.">
                        <option value="">Select Vendor</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>
            <button type="submit" id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-150 shadow-lg"></button>
        </form>
    </div>
</div>


<!-- History Modal (Hidden from UI) -->
<div id="historyModal" class="modal" style="display:none;">
    <div class="modal-content">
        <button class="close-button absolute top-3 right-5 text-gray-400 hover:text-gray-700 text-3xl font-light leading-none" onclick="closeModal('historyModal')">&times;</button>
        
        <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto mt-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">
                Tracking History for: <span id="historySourceName" class="text-indigo-600 font-bold"></span>
            </h3>
            <ul id="historyList" class="space-y-4">
                <!-- History entries will be populated here -->
            </ul>
        </div>
    </div>
</div>

<script>
    // --- CHARACTER DIFF LOGIC (RETAINED FOR HISTORY LOGGING) ---
    const diffAndHighlightCharLevel = (oldVal, newVal) => {
        let oldOutput = '';
        let newOutput = '';
        
        const maxLen = Math.max(oldVal.length, newVal.length);

        for (let i = 0; i < maxLen; i++) {
            const oldChar = oldVal[i] || '';
            const newChar = newVal[i] || '';

            if (oldChar === newChar) {
                oldOutput += oldChar;
                newOutput += newChar;
            } else {
                if (oldChar) {
                    oldOutput += `<span class="bg-red-200 text-red-800 font-bold">${oldChar}</span>`;
                }
                if (newChar) {
                    newOutput += `<span class="bg-green-200 text-green-800 font-bold">${newChar}</span>`;
                }
            }
        }
        return { old: oldOutput, new: newOutput };
    };

    const highlightChangesInDescription = (description) => {
        const regex = /'([^']*)'/g; 
        const values = [];
        let match;
        while (match = regex.exec(description)) {
            values.push(match[1]);
        }
        
        if (values.length === 2) {
            const oldValue = values[0];
            const newValue = values[1];
            
            const fieldName = description.split(' ')[0];
            
            const highlighted = diffAndHighlightCharLevel(oldValue, newValue);
            
            return `
                ${fieldName} changed: 
                <span class="inline-block px-2 py-0.5 rounded-md bg-red-100 text-red-800 text-xs mr-2">OLD</span>
                <span class="break-words">${highlighted.old}</span>
                <span class="mx-2 text-gray-500 font-semibold">→</span>
                <span class="inline-block px-2 py-0.5 rounded-md bg-green-100 text-green-800 text-xs mr-2">NEW</span>
                <span class="break-words">${highlighted.new}</span>
            `;
        } else {
            return description;
        }
    };
    // --- END CHARACTER DIFF LOGIC ---


    document.addEventListener('DOMContentLoaded', () => {
        const dataTableBody = document.querySelector('#dataTable tbody');
        
        // --- CATEGORY STATE ---
        // Categories: The top-level grouping
        let categories = ['NATCRIM']; // ONLY NATCRIM
        // Subcategories: The second-level grouping (OIG, SOR, etc.)
        let subCategories = ['OIG', 'SOR', 'GSA/SAM', 'TW']; // Removed Verification and U.S. District Courts
        let vendors = ['SJV']; 
        
        // --- CATEGORY ASSIGNMENTS ---
        // Maps Category to an array of assigned Subcategories
        let categoryAssignments = {
            'NATCRIM': ['OIG', 'SOR', 'GSA/SAM', 'TW']
        };

        // Filter Elements
        const filterExampleOf = document.getElementById('filterExampleOf');
        const filterSubCategory = document.getElementById('filterSubCategory'); // New Subcategory Filter
        const filterVendor = document.getElementById('filterVendor');
        const filterSourceName = document.getElementById('filterSourceName');
        
        // Modals
        const addUpdateModal = document.getElementById('addUpdateModal');
        const modalTitle = document.getElementById('modalTitle');
        const dataForm = document.getElementById('dataForm');
        const saveBtn = document.getElementById('saveBtn');
        
        // Modal Select Fields
        const categorySelect = document.getElementById('exampleOfSelect'); 
        const subCategorySelect = document.getElementById('subCategorySelect'); // New Subcategory Dropdown
        const vendorSelect = document.getElementById('vendorSelect');
        const sourceNameInput = document.getElementById('sourceName');
        
        const initialTimestamp = (new Date()).toLocaleString();
        
        // --- INITIAL DATA ARRAY (CLEANED LIST) ---
        let data = [
            // OIG Entries (5 Total)
            { category: 'NATCRIM', subCategory: 'OIG', sourceName: 'HEALTH & HUMAN SERVICES COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'OIG', sourceName: 'MEDICARE SANCTIONS/EXCLUSION DATABASE COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'OIG', sourceName: 'US_HHS_EXCLUSIONS COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'OIG', sourceName: 'HHS DATABASE COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'OIG', sourceName: 'US_SAM_EXCLUSIONS COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },

            // SOR Entries (5 Total)
            { category: 'NATCRIM', subCategory: 'SOR', sourceName: 'SEX OFFENDER REGISTRY COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'SOR', sourceName: 'INDIANA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'SOR', sourceName: 'TEXAS SEX OFFENDER REGISTRY COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'SOR', sourceName: 'LOUISIANA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'SOR', sourceName: 'ARIZONA SEX OFFENDER REGISTRY COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            
            // ARREST (Mapped under GSA/SAM for structure, 1 Total)
            { category: 'NATCRIM', subCategory: 'GSA/SAM', sourceName: 'ARREST/US/NATIONAL/RECENTLY_BOOKED COURT', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            
            // TW Entries (5 Total)
            { category: 'NATCRIM', subCategory: 'TW', sourceName: 'FBI Terrorist Screening Center (TSC)', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'TW', sourceName: 'OFAC (Treasury) SDN List', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'TW', sourceName: 'U.S. Dept. of State Foreign Terrorist Organizations (FTO) list', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'TW', sourceName: 'TSA No Fly List & Traveler Redress', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            { category: 'NATCRIM', subCategory: 'TW', sourceName: 'Executive Orders / State Dept sanctions (EO 13224)', vendor: 'SJV', history: [{ timestamp: initialTimestamp, updateDetails: 'Initial creation.' }] },
            
        ]; // Total entries: 16
        // --- END DATA ARRAY ---

        let isUpdating = false;
        let updatingIndex = -1;

        // --- CORE UI/DATA FUNCTIONS ---
        
        // Filters options for the Subcategory dropdown based on the selected Category
        const filterSubcategoryOptions = (parentCategory) => {
            const assignedSubs = categoryAssignments[parentCategory] || [];
            
            // Re-render the subCategorySelect dropdown
            let currentValue = subCategorySelect.value;
            subCategorySelect.innerHTML = `<option value="">Select Subcategory</option>`;
            
            if (parentCategory) {
                assignedSubs.sort().forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subCategorySelect.appendChild(option);
                });
            }
            subCategorySelect.value = assignedSubs.includes(currentValue) ? currentValue : '';
        };

        // Function to refresh dropdown options
        const refreshDropdowns = () => {
            // Category Dropdowns (Filter and Add/Update Modal)
            [filterExampleOf, categorySelect].forEach(select => {
                let currentValue = select.value;
                const defaultText = select === filterExampleOf ? 'Category' : 'Select Category';
                select.innerHTML = `<option value="">${defaultText}</option>`;
                
                // --- FIX: Filter the modal dropdown to ONLY show NATCRIM ---
                const categoriesToDisplay = categories.filter(c => c === 'NATCRIM');

                categoriesToDisplay.sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
                
                // Keep filterExampleOf stuck on NATCRIM unless manually changed
                if (select === filterExampleOf) {
                    select.value = 'NATCRIM'; 
                } else {
                    select.value = currentValue || 'NATCRIM';
                }
            });
            
            // Subcategory Filter Dropdown (All subcategories)
            let filterSubCurrentValue = filterSubCategory.value;
            filterSubCategory.innerHTML = `<option value="">Subcategory</option>`;
            subCategories.sort().forEach(sub => {
                const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    filterSubCategory.appendChild(option);
            });
            filterSubCategory.value = filterSubCurrentValue;


            // Vendor Dropdowns
            [filterVendor, vendorSelect].forEach(select => {
                let currentValue = select.value;
                select.innerHTML = select === filterVendor ? '<option value="">Vendor</option>' : '<option value="">Select Vendor</option>';
                vendors.sort().forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
            
            // Initial filter of Subcategories in Add/Update Modal
            filterSubcategoryOptions(categorySelect.value);
        };

        // Function to render the table
        const renderTable = (dataToRender) => {
            dataTableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No results found matching your filter.</td></tr>';
                return;
            }
            dataToRender.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                const permanentIndex = data.findIndex(d => d === item);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.subCategory}</td>
                    <td class="px-6 py-4">${item.sourceName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.vendor}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="action-text-btn update-btn" data-index="${permanentIndex}">Update</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="action-text-btn delete-btn" data-index="${permanentIndex}" title="Delete Record"><i class="fas fa-trash-can"></i></button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
        };

        // Function to filter the data based on all criteria
        const applyFilters = () => {
            const selectedCategory = filterExampleOf.value;
            const selectedSubCategory = filterSubCategory.value;
            const selectedVendor = filterVendor.value;
            const searchTermSourceName = filterSourceName.value.trim().toLowerCase();

            // Set the Category filter to NATCRIM if cleared (to maintain the default view)
            const activeCategoryFilter = selectedCategory || 'NATCRIM';

            const filteredData = data.filter(item => {
                const matchesCategory = !activeCategoryFilter || item.category === activeCategoryFilter;
                const matchesSubCategory = !selectedSubCategory || item.subCategory === selectedSubCategory;
                const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
                const matchesSourceName = !searchTermSourceName || item.sourceName.toLowerCase().includes(searchTermSourceName);

                return matchesCategory && matchesSubCategory && matchesVendor && matchesSourceName;
            });

            renderTable(filteredData);
        };
        
        // --- MANAGE CATEGORIES LOGIC (Unused in current UI, kept for reference) ---
        
        const isCategoryUsed = (type, value) => {
            if (type === 'category') {
                if (data.some(item => item.category === value)) return true;
                if (categoryAssignments[value] && categoryAssignments[value].length > 0) return true;
                return false;
            } else if (type === 'vendor') {
                return data.some(item => item.vendor === value);
            } else if (type === 'subCategory') {
                const assigned = Object.values(categoryAssignments).flat();
                if (assigned.includes(value)) return true;
                return data.some(item => item.subCategory === value);
            }
            return false;
        };

        // --- HANDLERS (Simplified for current UI) ---
        
        // Category/Subcategory Modal Change Handler
        const handleModalCategoryChange = () => {
            const selectedCategory = categorySelect.value;
            filterSubcategoryOptions(selectedCategory);
            subCategorySelect.value = ''; // Clear subcategory when category changes
            sourceNameInput.value = ''; // Clear source name on category change
        };
        categorySelect.addEventListener('change', handleModalCategoryChange);
        subCategorySelect.addEventListener('change', () => {
             sourceNameInput.value = ''; // Clear source name on subcategory change
        });
        

        // Main Renaming Logic (Simplified)
        const handleRename = (type, oldValue) => {
            // Logic removed for management console since it's not visible
            alert("Management console functionality is currently inactive.");
        };
        
        // Main Deletion Logic (Simplified)
        const handleDelete = (type, value) => {
             // Logic removed for management console since it's not visible
            alert("Management console functionality is currently inactive.");
        };

        // --- UI INITIALIZATION & EVENT HANDLERS ---
        
        // Initial setup
        refreshDropdowns();
        // Set the initial filter value and apply the filter
        filterExampleOf.value = 'NATCRIM'; 
        applyFilters(); 
        
        // Open/Close Modals
        
        document.getElementById('addCheckBtn').addEventListener('click', () => {
            openModal('add');
        });

        // --- BUTTON HANDLERS ---
        document.getElementById('searchFilterBtn').addEventListener('click', applyFilters);

        document.getElementById('clearFilterBtn').addEventListener('click', () => {
            filterExampleOf.value = 'NATCRIM'; // Resetting to default NATCRIM view
            filterSubCategory.value = '';
            filterVendor.value = '';
            filterSourceName.value = '';
            applyFilters();
        });
        // --- END BUTTON HEADLERS ---
        
        // Universal Modal Close Function
        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'addUpdateModal') {
                 dataForm.reset();
            }
        };

        const openModal = (mode, index = -1) => {
            isUpdating = mode === 'update';
            updatingIndex = index;
            modalTitle.textContent = isUpdating ? 'Update Existing Check' : 'Add New Check';
            saveBtn.textContent = isUpdating ? 'Save Changes' : 'Add Check';
            
            // Ensure dropdowns are current before setting values
            refreshDropdowns();

            if (isUpdating) {
                const item = data[index];
                categorySelect.value = item.category;
                // Immediately filter subcategories based on the loaded category
                filterSubcategoryOptions(item.category);
                subCategorySelect.value = item.subCategory;
                sourceNameInput.value = item.sourceName;
                vendorSelect.value = item.vendor;
            } else {
                dataForm.reset();
                // SET DEFAULT VALUES
                categorySelect.value = 'NATCRIM';
                filterSubcategoryOptions('NATCRIM'); // Filter subs for NATCRIM
                vendorSelect.value = 'SJV'; 
            }
            addUpdateModal.style.display = 'flex';
        };

        // Form Submission (Add/Update Logic)
        dataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newCategory = categorySelect.value;
            const newSubCategory = subCategorySelect.value;
            const newSourceName = sourceNameInput.value.trim();
            const newVendor = vendorSelect.value;
            const now = (new Date()).toLocaleString();
            
            if (!newCategory || !newSubCategory || !newSourceName || !newVendor) {
                alert("Please fill out all required fields.");
                return;
            }

            const newSubCategoryValue = newSubCategory;


            if (isUpdating) {
                const originalItem = data[updatingIndex];
                let updateDetails = [];

                if (originalItem.category !== newCategory) {
                    updateDetails.push(`Category changed from '${originalItem.category}' to '${newCategory}'`);
                }
                 if (originalItem.subCategory !== newSubCategoryValue) {
                    updateDetails.push(`Subcategory changed from '${originalItem.subCategory}' to '${newSubCategoryValue}'`);
                }
                if (originalItem.sourceName !== newSourceName) {
                    updateDetails.push(`Source Name changed from '${originalItem.sourceName}' to '${newSourceName}'`);
                }
                if (originalItem.vendor !== newVendor) {
                    updateDetails.push(`Vendor changed from '${originalItem.vendor}' to '${newVendor}'`);
                }

                if (updateDetails.length > 0) {
                    originalItem.history.push({ 
                        timestamp: now, 
                        updateDetails: updateDetails.join(', ') 
                    });
                } else {
                     originalItem.history.push({ 
                        timestamp: now, 
                        updateDetails: 'No changes detected, record touched up.' 
                    });
                }
                
                originalItem.category = newCategory;
                originalItem.subCategory = newSubCategoryValue; 
                originalItem.sourceName = newSourceName;
                originalItem.vendor = newVendor;

            } else {
                data.push({ 
                    category: newCategory, 
                    subCategory: newSubCategoryValue,
                    sourceName: newSourceName, 
                    vendor: newVendor,
                    history: [{ timestamp: now, updateDetails: 'New record created.' }]
                });
            }
            
            applyFilters(); // Re-render table, respecting current filters
            closeModal('addUpdateModal');
        });

        // Delegate Table Actions (Update, Delete)
        dataTableBody.addEventListener('click', (e) => {
            
            if (e.target.classList.contains('update-btn')) {
                // Get permanent index stored in the data attribute
                const originalIndex = parseInt(e.target.getAttribute('data-index'));
                openModal('update', originalIndex);

            } else if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                // Get permanent index stored in the data attribute
                const targetButton = e.target.closest('.delete-btn');
                const originalIndex = parseInt(targetButton.getAttribute('data-index'));

                // Custom delete confirmation modal
                const confirmMessage = document.createElement('div');
                confirmMessage.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]';
                confirmMessage.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm text-center">
                        <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                        <p class="mb-6">Are you sure you want to delete the record for: <strong>${data[originalIndex].sourceName}</strong>?</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Delete</button>
                            <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmMessage);
                
                document.getElementById('confirmDelete').onclick = function() {
                    data.splice(originalIndex, 1);
                    applyFilters(); // Re-render table after deletion
                    refreshDropdowns(); // Refresh dropdowns in case a category was deleted
                    confirmMessage.remove();
                };
                document.getElementById('cancelDelete').onclick = function() {
                    confirmMessage.remove();
                };
            }
        });
    });
</script>

</body>
</html>
